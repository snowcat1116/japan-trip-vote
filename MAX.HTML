<!DOCTYPE html>
<html lang="zh-TW" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¤§é˜ªæ—…éŠ v1.5 </title>
    
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0f172a">
    
    <script src="https://unpkg.com/vue@3/dist/vue.global.js" data-cfasync="false"></script>
    <script src="https://cdn.tailwindcss.com" data-cfasync="false"></script>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: { extend: { colors: { darkbg: '#0f172a', glass: 'rgba(30, 41, 59, 0.9)', accent: '#38bdf8' } } }
        }
    </script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; -webkit-tap-highlight-color: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .loader { width: 14px; height: 14px; border: 2px solid #FFF; border-bottom-color: transparent; border-radius: 50%; display: inline-block; animation: rotation 1s linear infinite; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .glass-panel { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen pb-24 bg-[url('https://images.unsplash.com/photo-1542051841857-5f90071e7989?q=80&w=1920&auto=format&fit=crop')] bg-cover bg-center bg-fixed bg-no-repeat bg-blend-overlay">

<div id="app" class="max-w-md mx-auto relative min-h-screen flex flex-col">

    <div v-if="globalError" class="fixed top-0 left-0 w-full bg-red-600 text-white text-xs p-2 z-[9999] text-center">
        âš ï¸ ç³»çµ±éŒ¯èª¤: {{ globalError }}
    </div>

    <div v-if="!currentUser" class="fixed inset-0 z-50 bg-gray-900 flex flex-col items-center justify-center p-6 space-y-6">
        <div class="text-center">
            <h1 class="text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-purple-500 mb-2">å¤§é˜ªæ—…éŠ</h1>
            <p class="text-gray-400 text-sm">v1.5</p>
        </div>
        <div class="w-full max-w-xs space-y-4">
            <input type="password" inputmode="numeric" v-model="loginInput" class="w-full bg-gray-800 border border-gray-700 rounded-2xl p-4 text-center text-xl font-bold tracking-widest focus:border-accent outline-none transition text-white placeholder-gray-600" placeholder="è¼¸å…¥å¯†ç¢¼">
            <button @click="loginCheck" :disabled="isLoggingIn" class="w-full bg-accent hover:bg-blue-400 text-gray-900 font-bold py-4 rounded-2xl shadow-lg transition transform active:scale-95 flex justify-center items-center gap-2 disabled:opacity-50">
                <span v-if="isLoggingIn" class="loader border-gray-900 border-b-transparent"></span>
                <span v-else>ç™»å…¥ç³»çµ±</span>
            </button>
        </div>
    </div>

    <template v-else>
        <header class="px-5 py-4 flex justify-between items-center sticky top-0 z-20 glass-panel rounded-b-2xl shadow-lg mx-2 mt-2">
            <div>
                <h1 class="text-lg font-bold text-white shadow-black drop-shadow-md">Hello, {{ currentUser.name }} ğŸ‘‹</h1>
                <div class="flex items-center gap-2 text-[10px] text-gray-300">
                    <span :class="gpsStatus==='ok'?'text-green-400':'text-yellow-400'">â—</span> {{ locationName }}
                </div>
            </div>
            <div class="flex flex-col items-end gap-1">
                <div class="flex gap-2">
                    <button @click="syncData" :disabled="isSyncing" class="text-[10px] bg-blue-500/20 text-blue-300 px-2 py-1 rounded border border-blue-500/30 flex items-center gap-1">
                        <span v-if="isSyncing" class="loader w-3 h-3 border-blue-300"></span>
                        <span v-else>â˜ï¸ åŒæ­¥</span>
                    </button>
                    <button @click="logout" class="text-[10px] bg-red-500/20 text-red-300 px-2 py-1 rounded border border-red-500/30">ç™»å‡º</button>
                </div>
                <div class="text-[10px] text-gray-400">åŒ¯ç‡ {{ rate }}</div>
            </div>
        </header>

        <main class="flex-1 p-3 overflow-y-auto no-scrollbar space-y-4">
            
            <div v-show="currentTab === 'dashboard'" class="space-y-4">
                <div class="glass-panel rounded-2xl p-4">
                    <div class="flex gap-2 mb-3 overflow-x-auto no-scrollbar">
                         <button v-for="c in ['gps', 'osaka', 'kyoto', 'nara']" :key="c" @click="switchLocation(c)"
                            class="px-3 py-1 rounded-full text-xs font-bold transition-all border border-transparent"
                            :class="activeLoc === c ? 'bg-accent text-gray-900' : 'bg-gray-800/50 text-gray-400 border-gray-700'">
                            {{ cityLabels[c] }}
                        </button>
                    </div>
                    <div class="grid grid-cols-3 gap-2 text-center divide-x divide-gray-700/50">
                        <div v-for="(day, i) in weather.daily" :key="i" class="flex flex-col items-center">
                            <span class="text-[10px] text-gray-400">{{ i===0?'ä»Šå¤©':(i===1?'æ˜å¤©':'å¾Œå¤©') }}</span>
                            <span class="text-2xl my-1">{{ day.icon }}</span>
                            <div class="text-sm font-bold">{{ day.max }}Â°</div>
                        </div>
                    </div>
                </div>

                <div class="glass-panel rounded-2xl p-5 relative">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="font-bold text-lg">ğŸ›’ è³¼ç‰©è¨ˆç®—</h2>
                        <button @click="toggleCalcMode" class="text-[10px] bg-gray-800 px-2 py-1 rounded text-gray-400 border border-gray-700">{{ calcMode==='cart'?'åˆ‡æ›å–®å“':'åˆ‡æ›æ¹Šå–®' }}</button>
                    </div>

                    <div v-if="calcMode === 'cart'" class="mb-3">
                        <div v-if="cartItems.length > 0" class="max-h-32 overflow-y-auto bg-gray-900/40 rounded-xl p-2">
                            <div v-for="(item, i) in cartItems" :key="i" class="flex justify-between text-sm py-1 border-b border-gray-700/50 last:border-0">
                                <div class="flex items-center gap-2 overflow-hidden">
                                    <span class="text-gray-400 text-xs">#{{i+1}}</span>
                                    <span class="text-white truncate">{{ item.note || 'æœªæ¨™è¨»' }}</span>
                                </div>
                                <div class="flex gap-3 shrink-0">
                                    <span class="font-mono">Â¥{{ item.price }}</span>
                                    <button @click="removeCartItem(i)" class="text-red-400">Ã—</button>
                                </div>
                            </div>
                        </div>
                        <div v-else class="text-center text-xs text-gray-500 py-2">æ¸…å–®æ˜¯ç©ºçš„</div>
                    </div>
                    
                    <div class="flex flex-col gap-2 mb-2">
                        <div v-if="calcMode === 'cart'" class="flex gap-2">
                            <input type="text" v-model="newItemNote" class="flex-1 bg-gray-800 border border-gray-600 rounded-lg p-2 text-sm text-center outline-none text-white placeholder-gray-500" placeholder="è¼¸å…¥å–®å“å‚™è¨»">
                        </div>
                        <div class="flex gap-2">
                            <input type="number" v-model.number="inputPrice" class="w-full bg-gray-900/50 border border-gray-600 rounded-xl p-3 text-xl font-bold text-center outline-none focus:border-accent text-white placeholder-gray-600" placeholder="Â¥ é‡‘é¡">
                            <button v-if="calcMode === 'cart'" @click="addToCart" class="bg-gray-700 px-4 rounded-xl text-white font-bold whitespace-nowrap active:scale-95 transition">åŠ å…¥</button>
                        </div>
                    </div>

                    <div class="mb-4">
                         <input type="text" v-model="expenseNote" class="w-full bg-gray-900/30 border border-gray-600 rounded-lg p-2 text-sm text-center outline-none focus:border-accent text-white placeholder-gray-500" :placeholder="calcMode==='cart' ? 'ç¸½æ¨™é¡Œ (å¦‚: å”å‰è¨¶å¾·)' : 'å‚™è¨» (å¦‚: ç« é­šç‡’)'">
                    </div>

                    <div class="bg-gray-900/60 rounded-xl p-3 border border-gray-700/50">
                        <div class="flex justify-between items-end mb-1">
                            <span class="text-xs text-gray-400">ç¸½é‡‘é¡</span>
                            <span class="text-2xl font-bold font-mono">Â¥{{ currentTotal.toLocaleString() }}</span>
                        </div>
                        <div class="w-full bg-gray-700 h-1.5 rounded-full mb-2 overflow-hidden">
                            <div class="h-full transition-all duration-500" :class="isTaxFree?'bg-green-500':'bg-yellow-500'" :style="{width: Math.min((currentTotal/5000)*100, 100)+'%'}"></div>
                        </div>
                        <div v-if="isTaxFree" class="text-green-400 text-xs font-bold text-center animate-pulse mb-1">ğŸ‰ å…ç¨…ï¼çœ Â¥{{ Math.floor(currentTotal*0.1) }}</div>
                        <div v-else class="text-yellow-500 text-xs text-center mb-1">é‚„å·® Â¥{{ 5000 - currentTotal }} å…ç¨…</div>
                        <div class="flex justify-between items-center pt-2 border-t border-gray-700/50 mt-2">
                            <span class="text-xs text-gray-400">ç´„å°å¹£</span>
                            <span class="text-xl font-bold text-accent">${{ finalPriceTwd.toLocaleString() }}</span>
                        </div>
                    </div>
                    <button @click="uploadExpense" :disabled="uploading" class="w-full mt-3 bg-gradient-to-r from-blue-600 to-blue-500 text-white py-3 rounded-xl text-sm font-bold shadow-lg flex justify-center items-center gap-2 active:scale-95 transition disabled:opacity-50">
                        <span v-if="uploading" class="loader"></span>
                        <span v-else>â˜ï¸ è¨˜å¸³ä¸¦å„²å­˜</span>
                    </button>
                </div>
            </div>

            <div v-show="currentTab === 'records'" class="space-y-4">
                <div class="flex bg-gray-800 rounded-lg p-1">
                    <button @click="recordSubTab='expense'" :class="recordSubTab==='expense'?'bg-gray-700 text-white':'text-gray-400'" class="flex-1 py-1 text-xs font-bold rounded">å·²è³¼ç´€éŒ„</button>
                    <button @click="recordSubTab='list'" :class="recordSubTab==='list'?'bg-gray-700 text-white':'text-gray-400'" class="flex-1 py-1 text-xs font-bold rounded">å¾…è²·æ¸…å–®</button>
                </div>
                
                <div v-if="recordSubTab==='expense'" class="space-y-2">
                    <div class="glass-panel p-3 rounded-xl flex justify-between items-center">
                         <span class="text-sm text-gray-400">æ‰€æœ‰ç´¯è¨ˆ</span>
                         <span class="text-xl font-bold text-accent">Â¥{{ localTotalExpense.toLocaleString() }}</span>
                    </div>
                    <div v-if="localExpenses.length===0" class="text-center text-gray-500 text-xs py-10">
                        æš«ç„¡è³‡æ–™<br>è«‹é»æ“Šå³ä¸Šè§’ã€ŒåŒæ­¥ã€æŠ“å–é›²ç«¯è³‡æ–™
                    </div>
                    
                    <div v-for="(rec, i) in localExpenses" :key="i" class="glass-panel p-3 rounded-xl flex justify-between items-start text-sm">
                        <div class="flex-1 mr-2">
                            <div class="font-bold text-gray-200 text-sm leading-snug break-words mb-1 whitespace-pre-wrap">{{ rec.desc || 'ä¸€èˆ¬æ¶ˆè²»' }}</div>
                            <div class="text-[10px] text-gray-500 flex gap-2">
                                <span>{{ rec.date }}</span>
                                <span v-if="rec.user" class="text-blue-300">({{ rec.user }})</span>
                            </div>
                        </div>
                        <div class="flex flex-col items-end gap-2 shrink-0">
                            <span class="font-mono font-bold text-accent">Â¥{{ rec.amount.toLocaleString() }}</span>
                            <button @click="deleteLocalExpense(i)" class="text-red-400 text-[10px] border border-red-500/30 px-2 py-0.5 rounded hover:bg-red-500/20">åˆªé™¤</button>
                        </div>
                    </div>
                </div>

                <div v-if="recordSubTab==='list'" class="space-y-3">
                    <div class="flex gap-2">
                        <input v-model="newItem" placeholder="è¼¸å…¥å¾…è²·ç‰©å“..." class="flex-1 bg-gray-900/50 border border-gray-600 rounded-lg px-3 py-2 text-sm text-white">
                        <button @click="uploadList" :disabled="uploading" class="bg-gray-700 px-4 rounded-lg font-bold text-white flex items-center justify-center min-w-[60px]">
                            <span v-if="uploading" class="loader w-4 h-4 border-2"></span>
                            <span v-else>å­˜å…¥</span>
                        </button>
                    </div>
                    <ul class="space-y-2">
                        <li v-for="(item, i) in localList" :key="i" class="flex items-center gap-3 p-3 glass-panel rounded-lg">
                            <span class="flex-1 text-sm">
                                {{ item.text }}
                                <span v-if="item.user" class="text-[10px] text-gray-400 ml-1">({{ item.user }})</span>
                            </span>
                            <button @click="deleteLocalList(i, item.text)" class="text-red-400 px-2 font-bold">Ã—</button>
                        </li>
                    </ul>
                </div>
            </div>
            
            <div v-show="currentTab === 'tools'" class="space-y-4">
                <h2 class="text-lg font-bold px-1">ğŸ§° ç”Ÿå­˜å·¥å…·</h2>
                
                <div class="glass-panel p-4 rounded-2xl relative border-l-4 border-accent">
                    <div class="flex justify-between items-start">
                        <h3 class="font-bold text-accent mb-2">ğŸ¨ é£¯åº—å¡ (çµ¦å¸æ©Ÿçœ‹)</h3>
                    </div>
                    <div @click="showHotelModal=true" class="cursor-pointer group">
                        <p class="font-bold text-lg text-white group-hover:text-blue-300 transition">{{ hotelInfo.name }}</p>
                        <p class="text-gray-400 text-sm mt-1">ã€’556-0002 å¤§é˜ªå¸‚æµªé€ŸåŒº...</p>
                        <p class="text-xs text-accent mt-3 text-center bg-accent/10 border border-accent rounded p-2">ğŸ‘‡ é»æ“Šå…¨è¢å¹•é¡¯ç¤ºå¤§å­—</p>
                    </div>
                </div>

                <div class="grid grid-cols-3 gap-2">
                    <a href="https://www.google.com/maps/search/convenience+store/" target="_blank" class="bg-gray-800 hover:bg-gray-700 p-3 rounded-xl flex flex-col items-center gap-1 transition">
                        <span class="text-2xl">ğŸª</span><span class="text-xs">æ‰¾è¶…å•†</span>
                    </a>
                    <a href="https://www.google.com/maps/search/toilet/" target="_blank" class="bg-gray-800 hover:bg-gray-700 p-3 rounded-xl flex flex-col items-center gap-1 transition">
                        <span class="text-2xl">ğŸš½</span><span class="text-xs">æ‰¾å»æ‰€</span>
                    </a>
                    <a href="https://www.google.com/maps/search/station/" target="_blank" class="bg-gray-800 hover:bg-gray-700 p-3 rounded-xl flex flex-col items-center gap-1 transition">
                        <span class="text-2xl">ğŸš‰</span><span class="text-xs">æ‰¾è»Šç«™</span>
                    </a>
                </div>

                <div class="glass-panel p-4 rounded-2xl">
                    <h3 class="font-bold text-accent mb-3">ğŸ—£ï¸ æ±‚ç”ŸæŒ‡æŒ‡é€š</h3>
                    <div class="grid grid-cols-2 gap-2">
                        <button v-for="(p, i) in phrases" :key="i" @click="activePhrase=p" class="bg-gray-800 p-2 rounded-lg text-left hover:bg-gray-700 transition">
                            <div class="text-xs text-gray-400">{{ p.tw }}</div>
                            <div class="text-sm font-bold truncate">{{ p.jp }}</div>
                        </button>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3">
                     <a href="https://subway.osakametro.co.jp/cn/guide/routemap.php" target="_blank" class="glass-panel p-4 rounded-2xl flex flex-col items-center justify-center gap-2 active:scale-95 transition">
                        <span class="text-3xl">ğŸš‡</span><span class="text-xs font-bold">åœ°éµä¸‹è¼‰é </span>
                    </a>
                    <a href="https://www.deepl.com/translator#ja/zh/" target="_blank" class="glass-panel p-4 rounded-2xl flex flex-col items-center justify-center gap-2 active:scale-95 transition">
                        <span class="text-3xl">ğŸ§©</span><span class="text-xs font-bold">DeepLç¿»è­¯</span>
                    </a>
                </div>
            </div>

            <div v-show="currentTab === 'coupons'" class="space-y-4">
                <h2 class="text-lg font-bold px-1">ğŸŸï¸ å„ªæƒ åˆ¸</h2>
                <a href="https://www.facebook.com/photo/?fbid=1303477224918164&set=pcb.1303477264918160" target="_blank" class="block bg-white rounded-xl overflow-hidden shadow-lg border-l-8 border-red-600 p-3 text-gray-900 group">
                    <div class="flex justify-between items-center"><h3 class="font-bold">Bic Camera</h3><div class="text-xl font-black text-red-600">10% + 7%</div></div>
                </a>
                <a href="https://www.letsgojp.com/coupon/288199/" target="_blank" class="block bg-white rounded-xl overflow-hidden shadow-lg border-l-8 border-yellow-400 p-3 text-gray-900">
                    <div class="flex justify-between items-center"><h3 class="font-bold">å”å‰è¨¶å¾·</h3><div class="text-xl font-black text-yellow-500">10% + 5%</div></div>
                </a>
                <a href="https://tw.matsumotokiyoshi.net/coupon_tw" target="_blank" class="block bg-white rounded-xl overflow-hidden shadow-lg border-l-8 border-blue-600 p-3 text-gray-900">
                    <div class="flex justify-between items-center"><h3 class="font-bold">æ¾æœ¬æ¸…</h3><div class="text-xl font-black text-blue-600">3% ~ 7%</div></div>
                </a>
            </div>
        </main>

        <nav class="fixed bottom-0 w-full max-w-md glass-panel border-t border-gray-700/50 pb-safe z-30 rounded-t-2xl">
            <div class="grid grid-cols-4 h-16">
                <button @click="currentTab='dashboard'" class="flex flex-col items-center justify-center transition" :class="currentTab==='dashboard'?'text-accent':'text-gray-500'"><span class="text-xl">ğŸ </span><span class="text-[10px]">é¦–é </span></button>
                <button @click="currentTab='records'" class="flex flex-col items-center justify-center transition" :class="currentTab==='records'?'text-accent':'text-gray-500'"><span class="text-xl">ğŸ“’</span><span class="text-[10px]">ç´€éŒ„</span></button>
                <button @click="currentTab='coupons'" class="flex flex-col items-center justify-center transition" :class="currentTab==='coupons'?'text-accent':'text-gray-500'"><span class="text-xl">ğŸŸï¸</span><span class="text-[10px]">å„ªæƒ </span></button>
                <button @click="currentTab='tools'" class="flex flex-col items-center justify-center transition" :class="currentTab==='tools'?'text-accent':'text-gray-500'"><span class="text-xl">ğŸ§°</span><span class="text-[10px]">å·¥å…·</span></button>
            </div>
        </nav>

        <div v-if="showHotelModal" class="fixed inset-0 z-50 bg-black flex flex-col justify-center items-center p-6 text-center" @click="showHotelModal=false">
            <h2 class="text-gray-400 mb-6 text-xl font-bold text-white">ã“ã“ã¾ã§ãŠé¡˜ã„ã—ã¾ã™<br><span class="text-xs font-normal text-gray-400">(è«‹è¼‰æˆ‘åˆ°é€™è£¡)</span></h2>
            <h1 class="text-3xl font-bold text-accent mb-4">{{ hotelInfo.name }}</h1>
            <div class="bg-gray-800 p-4 rounded-xl border border-gray-600 w-full">
                <p class="text-2xl font-bold text-white leading-relaxed select-all mb-4">{{ hotelInfo.jpAddress }}</p>
                <p class="text-xs text-gray-400 border-t border-gray-600 pt-2">{{ hotelInfo.enAddress }}</p>
            </div>
            <p class="text-gray-500 mt-10 text-xs">é»æ“Šä»»æ„è™•é—œé–‰</p>
        </div>

        <div v-if="activePhrase" class="fixed inset-0 z-50 bg-black bg-opacity-95 flex flex-col justify-center items-center p-6 text-center" @click="activePhrase=null">
            <h2 class="text-gray-400 mb-4">{{ activePhrase.tw }}</h2>
            <p class="text-4xl font-bold text-white mb-2">{{ activePhrase.jp }}</p>
            <p class="text-gray-500 text-sm">{{ activePhrase.pron }}</p>
            <p class="text-gray-600 mt-10 text-xs">é»æ“Šä»»æ„è™•é—œé–‰</p>
        </div>
    </template>
</div>

<script data-cfasync="false">
    const { createApp, ref, computed, onMounted, watch } = Vue;
    const APP_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz8vO5khUTo6VMXoXQzUBVcGYJfh2yBk-91cEKNyCB7yhbB2FsZ3i2Dq_rnTMn7IOMFZQ/exec"; 

    createApp({
        setup() {
            // Global Error Handler
            const globalError = ref(null);
            window.onerror = function(msg) { globalError.value = msg; };

            const cityLabels = { gps: 'ğŸ“', osaka: 'å¤§é˜ª', kyoto: 'äº¬éƒ½', nara: 'å¥ˆè‰¯' };

            const safeParse = (key, defaultVal) => {
                try {
                    const item = localStorage.getItem(key);
                    return item ? JSON.parse(item) : defaultVal;
                } catch (e) {
                    return defaultVal;
                }
            };

            const loginInput = ref("");
            const isLoggingIn = ref(false);
            const currentUser = ref(safeParse('v11_user', null));

            const isSyncing = ref(false);
            const syncData = async () => {
                isSyncing.value = true;
                try {
                    const res = await fetch(APP_SCRIPT_URL, {
                        method: 'POST', redirect: 'follow', headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                        body: JSON.stringify({ type: 'sync', password: currentUser.value.code })
                    });
                    const data = await res.json();
                    if (data.status === 'success') {
                        localExpenses.value = data.expenses;
                        localList.value = data.list;
                        alert("âœ… åŒæ­¥å®Œæˆï¼");
                    } else { alert("åŒæ­¥å¤±æ•—"); }
                } catch(e) { alert("ç„¡æ³•é€£ç·šè‡³é›²ç«¯"); }
                isSyncing.value = false;
            };

            const loginCheck = async () => {
                if(!loginInput.value) return; 
                isLoggingIn.value = true;
                try {
                    const res = await fetch(APP_SCRIPT_URL, {
                        method: 'POST', redirect: 'follow', headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                        body: JSON.stringify({ type: 'login', password: loginInput.value })
                    });
                    const data = await res.json(); 
                    if(data.status === 'success') {
                        const userObj = { code: loginInput.value, name: data.userName };
                        currentUser.value = userObj;
                        localStorage.setItem('v11_user', JSON.stringify(userObj));
                        syncData(); 
                    } else { alert("ç™»å…¥å¤±æ•—"); }
                } catch(e) { alert("é€£ç·šé©—è­‰å¤±æ•—"); }
                isLoggingIn.value = false;
            };
            const logout = () => { currentUser.value = null; localStorage.removeItem('v11_user'); loginInput.value = ""; };

            const currentTab = ref('dashboard');
            const recordSubTab = ref('expense');
            const uploading = ref(false);
            const rate = ref(0.23);
            const activeLoc = ref('gps');
            const gpsStatus = ref('pending');
            const locationName = ref('å®šä½ä¸­...');
            const weather = ref({ daily: [{},{},{}] });
            
            const calcMode = ref('cart');
            const inputPrice = ref(null);
            const cartItems = ref([]);
            const expenseNote = ref("");
            const newItemNote = ref("");
            
            const localExpenses = ref(safeParse('local_expenses', []));
            const localList = ref(safeParse('local_list', []));
            const newItem = ref("");

            const showHotelModal = ref(false);
            const hotelInfo = ref({
                name: "Ocean é€šå¤©é–£",
                jpAddress: "ã€’556-0002\nå¤§é˜ªåºœå¤§é˜ªå¸‚æµªé€ŸåŒºæµç¾é ˆæ± 1-10-12",
                enAddress: "1 Chome-10-12 Ebisuhigashi, Naniwa Ward, Osaka, 556-0002"
            });
            
            const activePhrase = ref(null);
            const phrases = [
                { tw: 'å»æ‰€åœ¨å“ªè£¡?', jp: 'ãƒˆã‚¤ãƒ¬ã¯ã©ã“ã§ã™ã‹?', pron: 'Toire wa doko desu ka?' },
                { tw: 'è«‹çµ¦æˆ‘æ°´', jp: 'ãŠæ°´ã‚’ãã ã•ã„', pron: 'Omizu o kudasai' },
                { tw: 'å¤šå°‘éŒ¢?', jp: 'ã„ãã‚‰ã§ã™ã‹?', pron: 'Ikura desu ka?' },
                { tw: 'è«‹å¹«æˆ‘çµå¸³', jp: 'ãŠä¼šè¨ˆãŠé¡˜ã„ã—ã¾ã™', pron: 'Okaikei onegaishimasu' },
                { tw: 'é€™å€‹', jp: 'ã“ã‚Œ', pron: 'Kore' },
                { tw: 'ä¸ç”¨è¢‹å­', jp: 'è¢‹ã¯ã„ã„ã§ã™', pron: 'Fukuro wa ii desu' },
            ];

            watch(localExpenses, v => localStorage.setItem('local_expenses', JSON.stringify(v)), {deep:true});
            watch(localList, v => localStorage.setItem('local_list', JSON.stringify(v)), {deep:true});

            const currentTotal = computed(() => {
                if (calcMode.value === 'single') return inputPrice.value || 0;
                return cartItems.value.reduce((a, b) => a + b.price, 0);
            });
            const isTaxFree = computed(() => currentTotal.value >= 5000);
            const finalPriceTwd = computed(() => Math.round((isTaxFree.value ? currentTotal.value : currentTotal.value*1.1)*rate.value));
            const localTotalExpense = computed(() => localExpenses.value.reduce((a,b)=>a+b.amount, 0));

            const toggleCalcMode = () => { calcMode.value=calcMode.value==='cart'?'single':'cart'; inputPrice.value=null; cartItems.value=[]; };
            
            const addToCart = () => { 
                if(inputPrice.value > 0) { 
                    cartItems.value.push({
                        price: inputPrice.value,
                        note: newItemNote.value || 'æœªæ¨™è¨»'
                    });
                    inputPrice.value = null; 
                    newItemNote.value = ""; 
                } 
            };
            
            const removeCartItem = (i) => cartItems.value.splice(i,1);

            const sendToBackend = async (payload) => {
                uploading.value = true;
                payload.password = currentUser.value.code;
                
                if (payload.type === 'expense') {
                    localExpenses.value.unshift({ 
                        amount: payload.amount, 
                        desc: payload.desc,
                        date: new Date().toLocaleTimeString('zh-TW', {month:'numeric', day:'numeric', hour:'2-digit', minute:'2-digit'}),
                        user: currentUser.value.name
                    });
                }
                if (payload.type === 'list') {
                    localList.value.unshift({ text: payload.item });
                }

                try {
                    await fetch(APP_SCRIPT_URL, {
                        method: 'POST', mode: 'no-cors', headers: {'Content-Type': 'text/plain'},
                        body: JSON.stringify(payload)
                    });
                    if (payload.type === 'expense') alert(`âœ… å·²è¨˜å¸³`);
                    if(payload.type==='expense') { cartItems.value=[]; inputPrice.value=null; expenseNote.value=""; newItemNote.value=""; }
                    if(payload.type==='list') newItem.value="";
                } catch(e) { } 
                uploading.value = false;
            };

            const uploadExpense = () => { 
                const amount = isTaxFree.value ? currentTotal.value : Math.floor(currentTotal.value * 1.1);
                
                let finalDesc = expenseNote.value.trim();
                if (calcMode.value === 'cart' && cartItems.value.length > 0) {
                    const details = cartItems.value.map(item => `â€¢ ${item.note} (Â¥${item.price})`).join('\n');
                    finalDesc = finalDesc ? `${finalDesc}\n${details}` : details;
                }
                if (!finalDesc) finalDesc = "ä¸€èˆ¬æ¶ˆè²»";

                if(amount>0 && confirm(`ç¢ºèªè¨˜å¸³ï¼š\n${finalDesc}\n\nç¸½é¡ Â¥${amount} ?`)) {
                    sendToBackend({type:'expense', amount: amount, desc: finalDesc});
                }
            };
            const uploadList = () => { if(newItem.value) sendToBackend({type:'list', item: newItem.value}); };
            const deleteLocalExpense = async (i) => {
                const target = localExpenses.value[i];
                if(!confirm("ç¢ºå®šåˆªé™¤æ­¤ç´€éŒ„ï¼Ÿ")) return;
                localExpenses.value.splice(i, 1);
                try {
                    await fetch(APP_SCRIPT_URL, {
                        method: 'POST', mode: 'no-cors', headers: {'Content-Type': 'text/plain'},
                        body: JSON.stringify({
                            type: 'delete_expense',
                            password: currentUser.value.code,
                            desc: target.desc || 'ä¸€èˆ¬æ¶ˆè²»',
                            amount: target.amount
                        })
                    });
                } catch(e) {}
            };
            const deleteLocalList = async (i, itemText) => { 
                localList.value.splice(i,1); 
                try {
                    await fetch(APP_SCRIPT_URL, {
                        method: 'POST', mode: 'no-cors', headers: {'Content-Type': 'text/plain'},
                        body: JSON.stringify({ type: 'delete_list', password: currentUser.value.code, item: itemText })
                    });
                } catch(e){}
            };

            const switchLocation = (loc) => {
                activeLoc.value = loc;
                if(loc==='gps') initGPS();
                else if(loc==='osaka') fetchW(34.69,135.50,'å¤§é˜ª');
                else if(loc==='kyoto') fetchW(35.01,135.76,'äº¬éƒ½');
                else if(loc==='nara') fetchW(34.68,135.80,'å¥ˆè‰¯');
            };
            const fetchW = async (lat,lon,n) => {
                locationName.value=n;
                try{
                    const r = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&daily=weathercode,temperature_2m_max,temperature_2m_min&timezone=Asia%2FTokyo&forecast_days=3`);
                    const d = await r.json();
                    weather.value.daily=d.daily.time.map((t,i)=>({max:Math.round(d.daily.temperature_2m_max[i]),icon:d.daily.weathercode[i]<3?"â˜€ï¸":d.daily.weathercode[i]<60?"â˜ï¸":"â˜”"}));
                }catch(e){}
            };
            const initGPS = () => {
                locationName.value="å®šä½ä¸­...";
                if(!navigator.geolocation){
                    console.log("GPS Blocked by user");
                    switchLocation('osaka');
                    return;
                }
                navigator.geolocation.getCurrentPosition(
                    p=>{gpsStatus.value='ok';fetchW(p.coords.latitude,p.coords.longitude,'GPS');},
                    e=>{
                        console.log("GPS Error", e);
                        gpsStatus.value='fail';
                        switchLocation('osaka');
                    }
                );
            };

            onMounted(() => {
                fetch('https://api.exchangerate-api.com/v4/latest/JPY').then(r=>r.json()).then(d=>rate.value=d.rates.TWD);
                initGPS();
            });

            return {
                globalError,
                loginInput, isLoggingIn, currentUser, loginCheck, logout,
                currentTab, recordSubTab, uploading, rate, activeLoc, gpsStatus, locationName, weather, switchLocation,
                calcMode, toggleCalcMode, inputPrice, cartItems, addToCart, removeCartItem,
                currentTotal, isTaxFree, finalPriceTwd, uploadExpense, uploadList, newItem,
                localExpenses, localList, localTotalExpense, deleteLocalExpense, deleteLocalList,
                expenseNote, newItemNote, cityLabels,
                showHotelModal, hotelInfo, activePhrase, phrases,
                syncData, isSyncing 
            };
        }
    }).mount('#app');
</script>
</body>
</html>

